<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gm.modules.user.dao.UserExperienceDao">

    <select id="selectPage" resultType="com.gm.modules.user.entity.UserExperienceEntity">
        SELECT
            SUM(A.USER_EX_NUM) AS USER_EX_NUM,
            A.NFT_ID,
            A.`STATUS`,
            A.CREATE_TIME,
            B.EXP_NAME,
            B.RARE_CODE,
            B.EXP,
            C.USER_NAME
        FROM
            GM_USER_EXPERIENCE A
        LEFT JOIN
            GM_EXPERIENCE B ON A.EXP_ID = B.ID
        LEFT JOIN
            GM_USER C ON A.USER_ID = C.USER_ID

        ${ew.customSqlSegment}
        GROUP BY A.USER_EX_NUM, A.NFT_ID, A.`STATUS`, A.CREATE_TIME, B.EXP_NAME, B.RARE_CODE, B.EXP, C.USER_NAME
        ORDER BY A.CREATE_TIME DESC,A.`STATUS` DESC
    </select>

    <!--获取玩家未使用的经验道具统计-->
    <select id="getUserExp" resultType="com.gm.modules.user.rsp.UserExpInfoRsp">
        SELECT
        count(*) AS EXP_NUM,
        AVG(A.SCALE) SCALE,
        A.NFT_ID,
        B.EXP_NAME,
        B.RARE_CODE AS EXP_RARE,
        B.EXP,
        B.ICON_URL,
        B.DESCRIPTION
        FROM
        GM_USER_EXPERIENCE A
        LEFT JOIN
        GM_EXPERIENCE B ON A.EXP_ID = B.ID
        <where>
            <if test="userId != null and userId != ''">
                AND A.`STATUS` = '1'
                AND A.USER_ID = #{userId}
            </if>
        </where>
        GROUP BY A.NFT_ID, B.EXP_NAME, B.RARE_CODE, B.EXP, B.ICON_URL, B.DESCRIPTION
        ORDER BY B.RARE_CODE
    </select>

    <!--获取玩家未使用的经验道具统计 升级用-->
    <select id="getUserExpDetailForUpgrade" resultType="com.gm.modules.user.rsp.UserExpInfoDetailRsp">
        SELECT
        count(*) AS EXP_NUM,
        AVG(A.SCALE) SCALE,
        B.EXP_NAME,
        B.RARE_CODE AS EXP_RARE,
        B.EXP
        FROM
        GM_USER_EXPERIENCE A
        LEFT JOIN
        GM_EXPERIENCE B ON A.EXP_ID = B.ID
        <where>
            <if test="userId != null and userId != ''">
                AND A.`STATUS` = '1'
                AND A.USER_ID = #{userId}
            </if>
        </where>
        GROUP BY B.EXP_NAME, B.RARE_CODE, B.EXP
        ORDER BY B.RARE_CODE
    </select>

    <!--获取玩家未使用的经验道具-->
    <select id="getUnusedExpFromPlayers" resultType="com.gm.modules.user.entity.UserExperienceEntity">
        SELECT
        A.*,
        B.EXP_NAME,
        B.RARE_CODE,
        B.EXP
        FROM
        GM_USER_EXPERIENCE A
        LEFT JOIN
        GM_EXPERIENCE B ON A.EXP_ID = B.ID
        <where>
            AND A.`STATUS` = '1'

            <if test="userId != null and userId != ''">
                AND A.USER_ID = #{userId}
            </if>

            <if test="rareCode != null and rareCode != ''">
                AND B.RARE_CODE = #{rareCode}
            </if>
        </where>
    </select>

    <!--消耗经验道具-->
    <update id="useExpProp">
        UPDATE GM_USER_EXPERIENCE
        SET `STATUS` = '2'
        WHERE
            ID IN (
                SELECT
                    T2.*
                FROM
                    (
                        SELECT
                            A.ID
                        FROM
                            GM_USER_EXPERIENCE A
                        LEFT JOIN GM_EXPERIENCE B ON A.EXP_ID = B.ID
                        WHERE
                            A.`STATUS` = '1'
                        AND A.USER_ID = #{userId}
                        AND B.RARE_CODE = #{rareCode}
                        ORDER BY
                            A.CREATE_TIME ASC
                        LIMIT #{useNum}
                    )AS T2
            );
    </update>

</mapper>